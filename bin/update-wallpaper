#!/bin/bash

while (( $# )); do
  if [[ -f ~/pictures/wallpapers/$1 ]]; then
    wallpaper=~/pictures/wallpapers/$1
  else
    if ! quotematches=$(<~/dotfiles/quotes.txt grep -v '^#' | grep -i "\<$1"); then
      echo >&2 "No quote found for: $1"
      exit 1
    fi
  fi
  shift
done

if [[ ! $wallpaper ]]; then
  wallpaper=$(find ~/pictures/wallpapers -iname '*.png' -o -iname '*.jpg' | shuf -n1)
fi
echo "image: $wallpaper"

if [[ ! $quotematches ]]; then
  quotematches=$(<~/dotfiles/quotes.txt grep -v '^#')
fi
quoteline=$(<<<"$quotematches" shuf -n1)
echo "quote: $quoteline"


render-text() {
  local text=$1
  local outfilebase=$2
  for foreground in white black; do
    pango-view \
      <(echo "$text") \
      --background "transparent" \
      --font "Gentium Bold 42" \
      --foreground "$foreground" \
      --hinting full \
      --indent -24 \
      --markup \
      --no-display \
      -o "$outfilebase-$foreground.png"
  done
  identify "$outfilebase-white.png" | grep -Po '\d+x\d+' | head -n1
}

dir=$(mktemp -dt generate-wallpaper.XXXX)

borderradius=20
bottompadding=150
quotepadding=20

primarysize=$(xrandr --current | grep primary | grep -Po '\d+x\d+')
width=$(cut -dx -f1 <<<"$primarysize")
height=$(cut -dx -f2 <<<"$primarysize")

# shellcheck disable=SC1111
quote="“$(<<<"$quoteline" sed 's# // #\n#g' | head -n-1 | awk 'NR==1 { print } NR>1 { print "<span alpha=\"1\">“</span>" $0 }' | sed "s/'/’/g")”"
quotesize=$(render-text "$quote" "$dir/quote")
quotewidth=$(cut -dx -f1 <<<"$quotesize")
quoteheight=$(cut -dx -f2 <<<"$quotesize")

author="— $(<<<"$quoteline" sed 's# // #\n#g' | tail -n1)"
authorsize=$(render-text "$author" "$dir/author")
authorwidth=$(cut -dx -f1 <<<"$authorsize")
authorheight=$(cut -dx -f2 <<<"$authorsize")

quoteboxwidth=$(( quotewidth + (2 * quotepadding) ))
quoteboxheight=$(( quoteheight + authorheight + (2 * quotepadding) ))

quoteboxx0=$(( width - quoteboxwidth ))
quoteboxy0=$(( height - bottompadding - quoteboxheight ))
quoteboxx1=$(( width + borderradius ))
quoteboxy1=$(( height - bottompadding ))

quotex=$(( width - quotewidth - quotepadding ))
quotey=$(( height - authorheight - quoteheight - quotepadding - bottompadding ))
authorx=$(( width - authorwidth - quotepadding ))
authory=$(( height - authorheight - quotepadding - bottompadding ))

# Resize wallpaper
echo "resizing..."
magick \
  "$wallpaper" \
  -resize "$primarysize^" \
  -gravity center \
  -extent "$primarysize" \
  -fill "#00000080" \
  -draw "roundRectangle $quoteboxx0,$quoteboxy0 $quoteboxx1,$quoteboxy1 $borderradius,$borderradius" \
  "$dir/resized.png"

# Layer everything together
echo "rendering..."
magick \
  "$dir/resized.png" \
  \( "$dir/quote-black.png" -repage "+$(( quotex + 2 ))+$(( quotey + 3 ))" \) \
  \( "$dir/quote-white.png" -repage "+$quotex+$quotey" \) \
  \( "$dir/author-black.png" -repage "+$(( authorx + 2 ))+$(( authory + 3 ))" \) \
  \( "$dir/author-white.png" -repage "+$authorx+$authory" \) \
  -layers flatten \
  ~/.cache/wallpaper.png

echo "done!"
feh --bg-max --image-bg black ~/.cache/wallpaper.png
