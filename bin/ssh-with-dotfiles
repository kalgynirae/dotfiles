#!/bin/bash
# ssh-with-dotfiles
# usage: <SCRIPT> [--debug] HOSTNAME   # transfer dotfiles and spawn a shell
#        <SCRIPT> [ARGS...]            # passthrough to regular SSH
#
# Collect dotfiles, transfer them to a remote host, and spawn a shell.
#
# Dotfiles are collected into a temporary directory by cd'ing into the tempdir
# and executing ~/.config/ssh-with-dotfiles/collect. collect is encouraged to
# log its actions to stdout (e.g. using 'cp -v'); this output will be hidden
# normally but shown with --debug.
#
# On the remote host, the collected dotfiles are placed in the directory
# ~/.$USER-ssh-home. HOME is set to this path. If
# ~/.$USER-ssh-home/.config/ssh-with-dotfiles/install exists, it is
# sourced (not executed!) with the original homedir passed as the only
# argument. Finally, '$SHELL -li' is spawned.
#
# For help with SSH itself, run with no args or see 'man ssh'.
set -u

REAL_SSH=/usr/bin/ssh
COMPRESS=gzip
DECOMPRESS=gzip

usage() {
  awk <"$0" -v script="$0" '/$^/{exit}; NR==2,0{gsub(/<SCRIPT>/, script); print substr($0, 3)}'
}

if [[ $# -gt 0 && $1 == --help ]]; then
  usage
  exit
elif [[ $# -eq 1 && $1 != -* ]]; then
  stdout=/dev/null
  hostname=$1
elif [[ $# -eq 2 && $1 == --debug && $2 != -* ]]; then
  stdout=/dev/stderr
  hostname=$2
else
  exec -a ssh "$REAL_SSH" "$@"
fi

if "$REAL_SSH" -O check "$hostname" 2>/dev/null; then
  echo >&2 "$0: ssh control socket exists; connecting directly..."
  exec -a ssh "$REAL_SSH" "$hostname"
fi

if [[ ! -e ~/.config/ssh-with-dotfiles/collect ]]; then
  echo >&2 "$0: ~/.config/ssh-with-dotfiles/collect doesn't exist; continuing without collecting dotfiles"
  exec -a ssh "$REAL_SSH" "$hostname"
fi

if ! tempdir=$(mktemp --tmpdir -d ssh-with-dotfiles.XXXX); then
  echo >&2 "$0: Failed to create temp dir; aborting"
  exit 1
fi
if ! cd "$tempdir"; then
  echo >&2 "$0: Failed to cd to the temp dir; aborting"
fi

printf >"$stdout" "\e[35m%s: Collecting dotfiles into %s...\e[39m\n" "$0" "$tempdir"
if ! ~/.config/ssh-with-dotfiles/collect >"$stdout" "$tempdir"; then
  echo >&2 "$0: Failed to collect dotfiles; aborting"
  exit 1
fi

if ! data=$(tar cf - -I "$COMPRESS" -C "$tempdir" . | base64 -); then
  echo >&2 "$0: Failed to tar and compress collected dotfiles; aborting"
  exit 1
fi

if ! rm -rf "$tempdir"; then
  echo >&2 "$0: warning: Failed to remove tempdir $tempdir"
fi

remote_script='
new_home=$1
decompress=$2
if ! mkdir -p "$new_home"; then
  printf >&2 "%s: Failed to create %s\n" "$0" "$new_home"
  exit 5
fi
if ! cd "$new_home"; then
  printf >&2 "%s: Failed to cd into %s\n" "$0" "$new_home"
  exit 5
fi
orig_home=$HOME
HOME=$new_home
printf "\e[36m%s: Extracting dotfiles into %s...\e[39m\n" "$0" "$new_home"
base64 -d - | tar xvf - --strip-components 1 -I "$decompress"
if [[ -e ~/.config/ssh-with-dotfiles/install ]]; then
  if ! source ~/.config/ssh-with-dotfiles/install "$orig_home"; then
    printf >&2 "%s remote: Install script failed\n" ${0@Q}
    exit 6
  fi
fi
'
printf >"$stdout" "\e[35m%s: Transferring dotfiles...\e[39m\n" "$0"
if ! "$REAL_SSH" >"$stdout" -o ControlMaster=yes -o ControlPersist=2s -t "$hostname" "bash -c ${remote_script@Q} ssh-with-dotfiles-remote ~/.${USER@Q}-ssh-home ${DECOMPRESS@Q}" <<<"$data"; then
  echo >&2 "$0: Failed to transfer dotfiles; aborting"
  exit 1
fi

printf >"$stdout" "\e[35m%s: Execing ssh...\e[39m\n" "$0"
exec -a "$0" "$REAL_SSH" "$hostname"
