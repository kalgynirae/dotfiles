#!/bin/bash
# ssh-with-dotfiles
# usage: <SCRIPT> [--debug] HOSTNAME   # transfer dotfiles and spawn a shell
#        <SCRIPT> [ARGS...]            # passthrough to regular SSH
#
# Collect dotfiles, transfer them to a remote host, and spawn a shell.
#
# Dotfiles are collected into a temporary directory by executing
# ~/.config/ssh-with-dotfiles/collect with the tempdir path as the first
# argument. collect is encouraged to log its actions to stdout (e.g. using
# 'cp -v'); this output will be hidden normally but shown with --debug.
#
# On the remote host, the collected dotfiles are placed in the directory
# ~/.$USER-ssh-home. HOME is set to this path. If
# ~/.$USER-ssh-home/.config/ssh-with-dotfiles/install exists, it is
# executed. Finally, '$SHELL -li' is spawned.
#
# For help with SSH itself, run with no args (or see 'man ssh').

usage() {
  awk <"$0" -v script="$0" '/$^/{exit}; NR==2,0{gsub(/<SCRIPT>/, script); print substr($0, 3)}'
}

if [[ $1 == --help ]]; then
  usage
  exit
elif [[ $# -eq 1 && $1 != -* ]]; then
  collect_stdout=/dev/null
  hostname=$1
elif [[ $# -eq 2 && $1 == --debug && $2 != -* ]]; then
  collect_stdout=/dev/stderr
  hostname=$2
else
  exec -a ssh /usr/bin/ssh "$@"
fi

if ! tempdir=$(mktemp -d ssh-with-dotfiles.XXXX); then
  echo >&2 "$0: Failed to create temp dir; continuing without dotfiles"
  exec -a ssh /usr/bin/ssh "$hostname"
fi

if ! ~/.config/ssh-with-dotfiles/collect "$tempdir" >"$collect_stdout"; then
  echo >&2 "$0: Failed to collect dotfiles; continuing without them"
  exec -a ssh /usr/bin/ssh "$hostname"
fi

data=$(tar cf - -I 'zstd -15' "$tempdir" | base64 -)

quoted_home=~/.${USER@Q}-ssh-home
exec -a ssh /usr/bin/ssh -t "$hostname" "
  mkdir -p $quoted_home &&
    export HOME=$quoted_home &&
    base64 -d <<<'$data' | tar xf - -I zstd
  if [[ -e ~/.config/ssh-with-dotfiles/install ]]; then
    ~/.config/ssh-with-dotfiles/install
  fi
  exec \$SHELL -li
"
