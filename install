#!/bin/bash

read -rp "Install packages? [y/N] "
if [[ $REPLY == y ]]; then
  known_packages() {
    comm -23 packages <(sudo pacman -S --needed $(<packages) |& grep "target not found" | awk '{print $5}')
  }
  sudo pacman -S --needed $(known_packages)
fi

maybelink() {
  if [[ ! -e $1 ]]; then
    echo "$1 doesn't exist; skipping"
  elif [[ $2 -ef $1 ]]; then
    echo "$2 is already correct; skipping"
  else
    [[ -d $(dirname "$2") ]] || mkdir -p "$(dirname "$2")"
    if [[ -e $2 || -h $2 ]]; then
      echo mv "$2" "$2.old"
      mv "$2" "$2.old"
    fi
    echo ln --symbolic --relative "$1" "$2"
    ln --symbolic --relative "$1" "$2"
  fi
}

maybelink XCompose ~/.XCompose
maybelink Xresources ~/.Xresources
maybelink alacritty.yml ~/.config/alacritty/alacritty.yml
maybelink atom-keymap.cson ~/.atom/keymap.cson
maybelink bash_profile ~/.bash_profile
maybelink bashrc ~/.bashrc
maybelink bin ~/bin
maybelink compton.conf ~/.config/compton.conf
maybelink dunstrc ~/.config/dunst/dunstrc
maybelink feh-themes ~/.config/feh/themes
maybelink fonts.conf ~/.config/fontconfig/fonts.conf
maybelink gitconfig ~/.gitconfig
maybelink gtk-3.0-settings.ini ~/.config/gtk-3.0/settings.ini
maybelink gtkrc-2.0 ~/.gtkrc-2.0
maybelink i3config ~/.config/i3/config
maybelink i3statusconfig ~/.config/i3status/config
maybelink inputrc ~/.inputrc
maybelink ipython_config.py ~/.ipython/profile_default/ipython_config.py
maybelink nvim ~/.config/nvim
maybelink nvim/init.vim ~/.vimrc
maybelink nvim/pack ~/.local/share/nvim/site/pack
maybelink profile ~/.profile
maybelink pythonrc ~/.pythonrc
maybelink roficonfig ~/.config/rofi/config
maybelink sound/compressor.service ~/.config/systemd/user/compressor.service
maybelink sound/default.pa ~/.config/pulse/default.pa
maybelink sound/jack.service ~/.config/systemd/user/jack.service
maybelink sxhkdrc ~/.config/sxhkd/sxhkdrc
maybelink tmux.conf ~/.tmux.conf
maybelink update-wallpaper.service ~/.config/systemd/user/update-wallpaper.service
maybelink update-wallpaper.timer ~/.config/systemd/user/update-wallpaper.timer
maybelink user-dirs.dirs ~/.config/user-dirs.dirs

for app in applications/*; do
  maybelink "$app" ~/.local/share/"$app"
done

tic -o ~/.terminfo -x tmux-fixed.terminfo

echo "Run 'git submodule update --init' to get the vim plugins"
